<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog CMS</title>
  <link rel="stylesheet" href="/site-style.css">
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    main{max-width:960px;margin:2rem auto;padding:0 1rem}
    form{display:grid;gap:0.75rem;margin-bottom:2rem}
    input, textarea{padding:0.5rem;border:1px solid #ddd;border-radius:6px;font:inherit}
    button{padding:0.6rem 1rem;border:1px solid #333;background:#111;color:#fff;border-radius:6px}
    .row{display:grid; gap:0.75rem; grid-template-columns:1fr 1fr}
    .error{background:#ffe6e6;border:1px solid #f5a; padding:0.75rem;border-radius:6px}
    .success{background:#e8fff1;border:1px solid #7c9; padding:0.75rem;border-radius:6px}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid #eee;padding:0.4rem 0.2rem;text-align:left}
    code{background:#f6f8fa;padding:0.1rem 0.3rem;border-radius:4px}
  </style>
  <script>
    async function loadPosts(){
      const list = document.getElementById('posts');
      list.innerHTML = '<tr><td colspan="3">Loading…</td></tr>';
      try {
        const res = await fetch('/api/admin/posts');
        const data = await res.json();
        if(!data.ok) throw new Error(data.message||'Failed');
        if(!data.posts.length){
          list.innerHTML = '<tr><td colspan="3">No posts yet</td></tr>';
          return;
        }
        list.innerHTML = data.posts.map(p=>`<tr>
          <td><a href="/posts/${encodeURIComponent(p.slug)}" target="_blank">${escapeHtml(p.title)}</a></td>
          <td><code>${escapeHtml(p.slug)}</code></td>
          <td><button onclick="del('${encodeURIComponent(p.slug)}')">Delete</button></td>
        </tr>`).join('');
      } catch(err){
        list.innerHTML = `<tr><td colspan="3" class="error">${err.message}</td></tr>`;
      }
    }
    function escapeHtml(s){
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    async function del(slug){
      if(!confirm('Delete this post?')) return;
      const res = await fetch('/api/admin/posts/'+slug, {method:'DELETE'});
      const d = await res.json();
      const msg = document.getElementById('msg');
      if(d.ok){ msg.className='success'; msg.textContent='Deleted'; loadPosts(); }
      else { msg.className='error'; msg.textContent = d.message + (d.detail ? ' – '+d.detail : ''); }
    }
    async function onSubmit(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      if(body.images){ body.images = body.images.split(',').map(s=>s.trim()).filter(Boolean); }
      const res = await fetch('/api/admin/posts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const d = await res.json();
      const msg = document.getElementById('msg');
      if(d.ok){ msg.className='success'; msg.textContent='Saved'; e.target.reset(); loadPosts(); }
      else { msg.className='error'; msg.textContent = d.message + (d.detail ? ' – '+d.detail : ''); }
    }
    window.addEventListener('DOMContentLoaded', ()=>{ loadPosts(); });
  </script>
</head>
<body>
  <main>
    <h1>Blog CMS</h1>
    <p>Create posts for the current host/site. Generated HTML inherits the site CSS.</p>

    <div id="msg"></div>

    <form onsubmit="onSubmit(event)">
      <div class="row">
        <div>
          <label>Title<br/>
            <input name="title" required placeholder="Post title" />
          </label>
        </div>
        <div>
          <label>Slug (optional)<br/>
            <input name="slug" placeholder="auto-from-title" />
          </label>
        </div>
      </div>
      <label>Images (comma-separated URLs)<br/>
        <input name="images" placeholder="https://… , https://…" />
      </label>
      <label>Content<br/>
        <textarea name="content" rows="10" required placeholder="Paste your content"></textarea>
      </label>
      <div><button type="submit">Generate & Save</button> <a href="/" style="margin-left:1rem">View Site</a></div>
    </form>

    <h2>Posts</h2>
    <table>
      <thead><tr><th>Title</th><th>Slug</th><th>Actions</th></tr></thead>
      <tbody id="posts"></tbody>
    </table>
  </main>
</body>
</html>

